import subprocess
import threading
from colorama import Fore
from colorama import Style


class CapaThread(threading.Thread):
    def __init__(self, path_exe, pid):
        threading.Thread.__init__(self)
        self.path_capa = "C:\\tasks\\exe\\capa.exe"
        self.path_exe = f'"{path_exe}"'
        path_dir = f'C:\\tasks\\analysis\\{pid}'
        self.path_out = path_dir + f'\\{pid}.capa'
        self.pid = pid

    def run(self) -> None:
        print(f'{Fore.LIGHTCYAN_EX}[{self.pid}][capa]: start{Style.RESET_ALL}')
        subprocess.call(f"{self.path_capa} -q {self.path_exe} > {self.path_out}", shell=True)

        set_color_start = b'\x1b\x5b\x33\x34\x6d'
        set_color_finish = b'\x1b\x5b\x30\x6d'
        data = b''
        with open(self.path_out, 'rb') as f:
            data = f.read()
            data = data.replace(set_color_start, b'').replace(set_color_finish, b'')
        with open(self.path_out, 'wb') as f:
            f.write(data)
        print(f'{Fore.LIGHTCYAN_EX}[{self.pid}][capa]: finish{Style.RESET_ALL}')
